revoke delete on table "public"."answers" from "anon";

revoke insert on table "public"."answers" from "anon";

revoke references on table "public"."answers" from "anon";

revoke select on table "public"."answers" from "anon";

revoke trigger on table "public"."answers" from "anon";

revoke truncate on table "public"."answers" from "anon";

revoke update on table "public"."answers" from "anon";

revoke delete on table "public"."answers" from "authenticated";

revoke insert on table "public"."answers" from "authenticated";

revoke references on table "public"."answers" from "authenticated";

revoke select on table "public"."answers" from "authenticated";

revoke trigger on table "public"."answers" from "authenticated";

revoke truncate on table "public"."answers" from "authenticated";

revoke update on table "public"."answers" from "authenticated";

revoke delete on table "public"."answers" from "service_role";

revoke insert on table "public"."answers" from "service_role";

revoke references on table "public"."answers" from "service_role";

revoke select on table "public"."answers" from "service_role";

revoke trigger on table "public"."answers" from "service_role";

revoke truncate on table "public"."answers" from "service_role";

revoke update on table "public"."answers" from "service_role";

revoke delete on table "public"."couple_members" from "anon";

revoke insert on table "public"."couple_members" from "anon";

revoke references on table "public"."couple_members" from "anon";

revoke select on table "public"."couple_members" from "anon";

revoke trigger on table "public"."couple_members" from "anon";

revoke truncate on table "public"."couple_members" from "anon";

revoke update on table "public"."couple_members" from "anon";

revoke delete on table "public"."couple_members" from "authenticated";

revoke insert on table "public"."couple_members" from "authenticated";

revoke references on table "public"."couple_members" from "authenticated";

revoke select on table "public"."couple_members" from "authenticated";

revoke trigger on table "public"."couple_members" from "authenticated";

revoke truncate on table "public"."couple_members" from "authenticated";

revoke update on table "public"."couple_members" from "authenticated";

revoke delete on table "public"."couple_members" from "service_role";

revoke insert on table "public"."couple_members" from "service_role";

revoke references on table "public"."couple_members" from "service_role";

revoke select on table "public"."couple_members" from "service_role";

revoke trigger on table "public"."couple_members" from "service_role";

revoke truncate on table "public"."couple_members" from "service_role";

revoke update on table "public"."couple_members" from "service_role";

revoke delete on table "public"."couple_requests" from "anon";

revoke insert on table "public"."couple_requests" from "anon";

revoke references on table "public"."couple_requests" from "anon";

revoke select on table "public"."couple_requests" from "anon";

revoke trigger on table "public"."couple_requests" from "anon";

revoke truncate on table "public"."couple_requests" from "anon";

revoke update on table "public"."couple_requests" from "anon";

revoke delete on table "public"."couple_requests" from "authenticated";

revoke insert on table "public"."couple_requests" from "authenticated";

revoke references on table "public"."couple_requests" from "authenticated";

revoke select on table "public"."couple_requests" from "authenticated";

revoke trigger on table "public"."couple_requests" from "authenticated";

revoke truncate on table "public"."couple_requests" from "authenticated";

revoke update on table "public"."couple_requests" from "authenticated";

revoke delete on table "public"."couple_requests" from "service_role";

revoke insert on table "public"."couple_requests" from "service_role";

revoke references on table "public"."couple_requests" from "service_role";

revoke select on table "public"."couple_requests" from "service_role";

revoke trigger on table "public"."couple_requests" from "service_role";

revoke truncate on table "public"."couple_requests" from "service_role";

revoke update on table "public"."couple_requests" from "service_role";

revoke delete on table "public"."couples" from "anon";

revoke insert on table "public"."couples" from "anon";

revoke references on table "public"."couples" from "anon";

revoke select on table "public"."couples" from "anon";

revoke trigger on table "public"."couples" from "anon";

revoke truncate on table "public"."couples" from "anon";

revoke update on table "public"."couples" from "anon";

revoke delete on table "public"."couples" from "authenticated";

revoke insert on table "public"."couples" from "authenticated";

revoke references on table "public"."couples" from "authenticated";

revoke select on table "public"."couples" from "authenticated";

revoke trigger on table "public"."couples" from "authenticated";

revoke truncate on table "public"."couples" from "authenticated";

revoke update on table "public"."couples" from "authenticated";

revoke delete on table "public"."couples" from "service_role";

revoke insert on table "public"."couples" from "service_role";

revoke references on table "public"."couples" from "service_role";

revoke select on table "public"."couples" from "service_role";

revoke trigger on table "public"."couples" from "service_role";

revoke truncate on table "public"."couples" from "service_role";

revoke update on table "public"."couples" from "service_role";

revoke delete on table "public"."journals" from "anon";

revoke insert on table "public"."journals" from "anon";

revoke references on table "public"."journals" from "anon";

revoke select on table "public"."journals" from "anon";

revoke trigger on table "public"."journals" from "anon";

revoke truncate on table "public"."journals" from "anon";

revoke update on table "public"."journals" from "anon";

revoke delete on table "public"."journals" from "authenticated";

revoke insert on table "public"."journals" from "authenticated";

revoke references on table "public"."journals" from "authenticated";

revoke select on table "public"."journals" from "authenticated";

revoke trigger on table "public"."journals" from "authenticated";

revoke truncate on table "public"."journals" from "authenticated";

revoke update on table "public"."journals" from "authenticated";

revoke delete on table "public"."journals" from "service_role";

revoke insert on table "public"."journals" from "service_role";

revoke references on table "public"."journals" from "service_role";

revoke select on table "public"."journals" from "service_role";

revoke trigger on table "public"."journals" from "service_role";

revoke truncate on table "public"."journals" from "service_role";

revoke update on table "public"."journals" from "service_role";

revoke delete on table "public"."notifications" from "anon";

revoke insert on table "public"."notifications" from "anon";

revoke references on table "public"."notifications" from "anon";

revoke select on table "public"."notifications" from "anon";

revoke trigger on table "public"."notifications" from "anon";

revoke truncate on table "public"."notifications" from "anon";

revoke update on table "public"."notifications" from "anon";

revoke delete on table "public"."notifications" from "authenticated";

revoke insert on table "public"."notifications" from "authenticated";

revoke references on table "public"."notifications" from "authenticated";

revoke select on table "public"."notifications" from "authenticated";

revoke trigger on table "public"."notifications" from "authenticated";

revoke truncate on table "public"."notifications" from "authenticated";

revoke update on table "public"."notifications" from "authenticated";

revoke delete on table "public"."notifications" from "service_role";

revoke insert on table "public"."notifications" from "service_role";

revoke references on table "public"."notifications" from "service_role";

revoke select on table "public"."notifications" from "service_role";

revoke trigger on table "public"."notifications" from "service_role";

revoke truncate on table "public"."notifications" from "service_role";

revoke update on table "public"."notifications" from "service_role";

revoke delete on table "public"."photos" from "anon";

revoke insert on table "public"."photos" from "anon";

revoke references on table "public"."photos" from "anon";

revoke select on table "public"."photos" from "anon";

revoke trigger on table "public"."photos" from "anon";

revoke truncate on table "public"."photos" from "anon";

revoke update on table "public"."photos" from "anon";

revoke delete on table "public"."photos" from "authenticated";

revoke insert on table "public"."photos" from "authenticated";

revoke references on table "public"."photos" from "authenticated";

revoke select on table "public"."photos" from "authenticated";

revoke trigger on table "public"."photos" from "authenticated";

revoke truncate on table "public"."photos" from "authenticated";

revoke update on table "public"."photos" from "authenticated";

revoke delete on table "public"."photos" from "service_role";

revoke insert on table "public"."photos" from "service_role";

revoke references on table "public"."photos" from "service_role";

revoke select on table "public"."photos" from "service_role";

revoke trigger on table "public"."photos" from "service_role";

revoke truncate on table "public"."photos" from "service_role";

revoke update on table "public"."photos" from "service_role";

revoke delete on table "public"."plant_state" from "anon";

revoke insert on table "public"."plant_state" from "anon";

revoke references on table "public"."plant_state" from "anon";

revoke select on table "public"."plant_state" from "anon";

revoke trigger on table "public"."plant_state" from "anon";

revoke truncate on table "public"."plant_state" from "anon";

revoke update on table "public"."plant_state" from "anon";

revoke delete on table "public"."plant_state" from "authenticated";

revoke insert on table "public"."plant_state" from "authenticated";

revoke references on table "public"."plant_state" from "authenticated";

revoke select on table "public"."plant_state" from "authenticated";

revoke trigger on table "public"."plant_state" from "authenticated";

revoke truncate on table "public"."plant_state" from "authenticated";

revoke update on table "public"."plant_state" from "authenticated";

revoke delete on table "public"."plant_state" from "service_role";

revoke insert on table "public"."plant_state" from "service_role";

revoke references on table "public"."plant_state" from "service_role";

revoke select on table "public"."plant_state" from "service_role";

revoke trigger on table "public"."plant_state" from "service_role";

revoke truncate on table "public"."plant_state" from "service_role";

revoke update on table "public"."plant_state" from "service_role";

revoke delete on table "public"."posts" from "anon";

revoke insert on table "public"."posts" from "anon";

revoke references on table "public"."posts" from "anon";

revoke select on table "public"."posts" from "anon";

revoke trigger on table "public"."posts" from "anon";

revoke truncate on table "public"."posts" from "anon";

revoke update on table "public"."posts" from "anon";

revoke delete on table "public"."posts" from "authenticated";

revoke insert on table "public"."posts" from "authenticated";

revoke references on table "public"."posts" from "authenticated";

revoke select on table "public"."posts" from "authenticated";

revoke trigger on table "public"."posts" from "authenticated";

revoke truncate on table "public"."posts" from "authenticated";

revoke update on table "public"."posts" from "authenticated";

revoke delete on table "public"."posts" from "service_role";

revoke insert on table "public"."posts" from "service_role";

revoke references on table "public"."posts" from "service_role";

revoke select on table "public"."posts" from "service_role";

revoke trigger on table "public"."posts" from "service_role";

revoke truncate on table "public"."posts" from "service_role";

revoke update on table "public"."posts" from "service_role";

revoke delete on table "public"."prompts" from "anon";

revoke insert on table "public"."prompts" from "anon";

revoke references on table "public"."prompts" from "anon";

revoke select on table "public"."prompts" from "anon";

revoke trigger on table "public"."prompts" from "anon";

revoke truncate on table "public"."prompts" from "anon";

revoke update on table "public"."prompts" from "anon";

revoke delete on table "public"."prompts" from "authenticated";

revoke insert on table "public"."prompts" from "authenticated";

revoke references on table "public"."prompts" from "authenticated";

revoke select on table "public"."prompts" from "authenticated";

revoke trigger on table "public"."prompts" from "authenticated";

revoke truncate on table "public"."prompts" from "authenticated";

revoke update on table "public"."prompts" from "authenticated";

revoke delete on table "public"."prompts" from "service_role";

revoke insert on table "public"."prompts" from "service_role";

revoke references on table "public"."prompts" from "service_role";

revoke select on table "public"."prompts" from "service_role";

revoke trigger on table "public"."prompts" from "service_role";

revoke truncate on table "public"."prompts" from "service_role";

revoke update on table "public"."prompts" from "service_role";

revoke delete on table "public"."push_tokens" from "anon";

revoke insert on table "public"."push_tokens" from "anon";

revoke references on table "public"."push_tokens" from "anon";

revoke select on table "public"."push_tokens" from "anon";

revoke trigger on table "public"."push_tokens" from "anon";

revoke truncate on table "public"."push_tokens" from "anon";

revoke update on table "public"."push_tokens" from "anon";

revoke delete on table "public"."push_tokens" from "authenticated";

revoke insert on table "public"."push_tokens" from "authenticated";

revoke references on table "public"."push_tokens" from "authenticated";

revoke select on table "public"."push_tokens" from "authenticated";

revoke trigger on table "public"."push_tokens" from "authenticated";

revoke truncate on table "public"."push_tokens" from "authenticated";

revoke update on table "public"."push_tokens" from "authenticated";

revoke delete on table "public"."push_tokens" from "service_role";

revoke insert on table "public"."push_tokens" from "service_role";

revoke references on table "public"."push_tokens" from "service_role";

revoke select on table "public"."push_tokens" from "service_role";

revoke trigger on table "public"."push_tokens" from "service_role";

revoke truncate on table "public"."push_tokens" from "service_role";

revoke update on table "public"."push_tokens" from "service_role";

revoke delete on table "public"."questions" from "anon";

revoke insert on table "public"."questions" from "anon";

revoke references on table "public"."questions" from "anon";

revoke select on table "public"."questions" from "anon";

revoke trigger on table "public"."questions" from "anon";

revoke truncate on table "public"."questions" from "anon";

revoke update on table "public"."questions" from "anon";

revoke delete on table "public"."questions" from "authenticated";

revoke insert on table "public"."questions" from "authenticated";

revoke references on table "public"."questions" from "authenticated";

revoke select on table "public"."questions" from "authenticated";

revoke trigger on table "public"."questions" from "authenticated";

revoke truncate on table "public"."questions" from "authenticated";

revoke update on table "public"."questions" from "authenticated";

revoke delete on table "public"."questions" from "service_role";

revoke insert on table "public"."questions" from "service_role";

revoke references on table "public"."questions" from "service_role";

revoke select on table "public"."questions" from "service_role";

revoke trigger on table "public"."questions" from "service_role";

revoke truncate on table "public"."questions" from "service_role";

revoke update on table "public"."questions" from "service_role";

revoke delete on table "public"."users" from "anon";

revoke insert on table "public"."users" from "anon";

revoke references on table "public"."users" from "anon";

revoke select on table "public"."users" from "anon";

revoke trigger on table "public"."users" from "anon";

revoke truncate on table "public"."users" from "anon";

revoke update on table "public"."users" from "anon";

revoke delete on table "public"."users" from "authenticated";

revoke insert on table "public"."users" from "authenticated";

revoke references on table "public"."users" from "authenticated";

revoke select on table "public"."users" from "authenticated";

revoke trigger on table "public"."users" from "authenticated";

revoke truncate on table "public"."users" from "authenticated";

revoke update on table "public"."users" from "authenticated";

revoke delete on table "public"."users" from "service_role";

revoke insert on table "public"."users" from "service_role";

revoke references on table "public"."users" from "service_role";

revoke select on table "public"."users" from "service_role";

revoke trigger on table "public"."users" from "service_role";

revoke truncate on table "public"."users" from "service_role";

revoke update on table "public"."users" from "service_role";

revoke delete on table "public"."xp_events" from "anon";

revoke insert on table "public"."xp_events" from "anon";

revoke references on table "public"."xp_events" from "anon";

revoke select on table "public"."xp_events" from "anon";

revoke trigger on table "public"."xp_events" from "anon";

revoke truncate on table "public"."xp_events" from "anon";

revoke update on table "public"."xp_events" from "anon";

revoke delete on table "public"."xp_events" from "authenticated";

revoke insert on table "public"."xp_events" from "authenticated";

revoke references on table "public"."xp_events" from "authenticated";

revoke select on table "public"."xp_events" from "authenticated";

revoke trigger on table "public"."xp_events" from "authenticated";

revoke truncate on table "public"."xp_events" from "authenticated";

revoke update on table "public"."xp_events" from "authenticated";

revoke delete on table "public"."xp_events" from "service_role";

revoke insert on table "public"."xp_events" from "service_role";

revoke references on table "public"."xp_events" from "service_role";

revoke select on table "public"."xp_events" from "service_role";

revoke trigger on table "public"."xp_events" from "service_role";

revoke truncate on table "public"."xp_events" from "service_role";

revoke update on table "public"."xp_events" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.accept_couple_request(request_id uuid)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  me uuid := auth.uid();
  r public.couple_requests%rowtype;
  cid uuid;
  requester_name text;
  recipient_name text;
begin
  if me is null then
    raise exception 'not authenticated';
  end if;
  select * into r from public.couple_requests where id = request_id for update;
  if r.id is null then raise exception 'request not found'; end if;
  if r.status <> 'pending' then raise exception 'request not pending'; end if;
  if r.recipient_id <> me then raise exception 'only recipient can accept'; end if;

  -- ensure neither side is already in a couple
  if exists (select 1 from public.couple_members where user_id in (r.requester_id, r.recipient_id)) then
    raise exception 'one or both users already in a couple';
  end if;

  select coalesce(display_name, handle) into requester_name from public.users where id = r.requester_id;
  select coalesce(display_name, handle) into recipient_name from public.users where id = r.recipient_id;
  insert into public.couples (name) values (trim(both from (requester_name || ' × ' || recipient_name))) returning id into cid;
  insert into public.couple_members (couple_id, user_id, role) values (cid, r.requester_id, 'partner');
  insert into public.couple_members (couple_id, user_id, role) values (cid, r.recipient_id, 'partner');

  update public.couple_requests set status = 'accepted', responded_at = now() where id = r.id;

  -- optional: notify both
  insert into public.notifications (user_id, title, body) values (r.requester_id, 'Couple Request Accepted', 'You are now in a couple');
  insert into public.notifications (user_id, title, body) values (r.recipient_id, 'Couple Request Accepted', 'You are now in a couple');

  return cid;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.cancel_couple_request(request_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  me uuid := auth.uid();
  r public.couple_requests%rowtype;
begin
  select * into r from public.couple_requests where id = request_id for update;
  if r.id is null then raise exception 'request not found'; end if;
  if r.status <> 'pending' then raise exception 'request not pending'; end if;
  if r.requester_id <> me then raise exception 'only requester can cancel'; end if;
  update public.couple_requests set status = 'canceled', responded_at = now() where id = r.id;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.decline_couple_request(request_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  me uuid := auth.uid();
  r public.couple_requests%rowtype;
begin
  select * into r from public.couple_requests where id = request_id for update;
  if r.id is null then raise exception 'request not found'; end if;
  if r.status <> 'pending' then raise exception 'request not pending'; end if;
  if r.recipient_id <> me then raise exception 'only recipient can decline'; end if;
  update public.couple_requests set status = 'declined', responded_at = now() where id = r.id;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.is_couple_member(couple uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  select exists (
    select 1 from public.couple_members cm
    where cm.couple_id = couple and cm.user_id = auth.uid()
  );
$function$
;

CREATE OR REPLACE FUNCTION public.send_couple_request(recipient_handle text, msg text DEFAULT NULL::text)
 RETURNS couple_requests
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  me uuid := auth.uid();
  recip public.users%rowtype;
  existing_couple_me uuid;
  existing_couple_them uuid;
  req public.couple_requests%rowtype;
begin
  if me is null then
    raise exception 'not authenticated';
  end if;
  select * into recip from public.users where handle = recipient_handle;
  if recip.id is null then
    raise exception 'recipient not found';
  end if;
  if recip.id = me then
    raise exception 'cannot send request to yourself';
  end if;
  select couple_id into existing_couple_me from public.couple_members where user_id = me;
  select couple_id into existing_couple_them from public.couple_members where user_id = recip.id;
  if existing_couple_me is not null then
    raise exception 'you are already in a couple';
  end if;
  if existing_couple_them is not null then
    raise exception 'recipient is already in a couple';
  end if;
  insert into public.couple_requests (requester_id, recipient_id, message)
  values (me, recip.id, msg)
  returning * into req;

  -- optional: notify recipient
  insert into public.notifications (user_id, title, body)
  values (recip.id, 'Couple Request', 'You received a couple request');

  return req;
exception when unique_violation then
  raise exception 'a pending request already exists between you two';
end;
$function$
;


